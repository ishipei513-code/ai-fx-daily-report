import os
from datetime import datetime
import yfinance as yf
from crewai import Agent, Task, Crew, Process
from langchain_google_genai import ChatGoogleGenerativeAI

# 1. ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ï¼ˆä¿®æ­£ç‰ˆï¼‰
def get_market_data():
    # multi_level_index=False ã‚’è¿½åŠ ã™ã‚‹ã“ã¨ã§ã€ãƒ‡ãƒ¼ã‚¿ã‚’æ‰±ã„ã‚„ã™ã„å˜ç´”ãªå½¢å¼ã«ã—ã¾ã™
    data = yf.download("JPY=X", period="5d", interval="1d", multi_level_index=False)
    latest = data.iloc[-1]
    prev = data.iloc[-2]
    return latest, prev

latest, prev = get_market_data()

# 2. AIãƒ¢ãƒ‡ãƒ«ã®è¨­å®š (Gemini)
llm = ChatGoogleGenerativeAI(
    model="gemini-1.5-flash",
    google_api_key=os.getenv("GOOGLE_API_KEY")
)

# 3. ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å®šç¾©
analyst = Agent(
    role='ã‚·ãƒ‹ã‚¢FXã‚¢ãƒŠãƒªã‚¹ãƒˆ',
    goal='ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æã«åŸºã¥ãã€æ­£ç¢ºã§åˆ©ç›Šã«ã¤ãªãŒã‚‹ãƒ‰ãƒ«å††ç›¸å ´äºˆæ¸¬ã‚’æä¾›ã™ã‚‹',
    backstory='ã‚ãªãŸã¯20å¹´ã®çµŒé¨“ã‚’æŒã¤ãƒ—ãƒ­ã®FXãƒˆãƒ¬ãƒ¼ãƒ€ãƒ¼ã§ã™ã€‚RSIã€ç§»å‹•å¹³å‡ç·šã€ãƒœãƒªãƒ³ã‚¸ãƒ£ãƒ¼ãƒãƒ³ãƒ‰ãªã©ã®æŒ‡æ¨™ã‚’ä½¿ã„ã“ãªã—ã¾ã™ã€‚',
    llm=llm,
    allow_delegation=False
)

# 4. ã‚¿ã‚¹ã‚¯ã®å®šç¾©ï¼ˆâ˜…SEOå¼·åŒ–å‘½ä»¤ã‚’çµ„ã¿è¾¼ã¿æ¸ˆã¿ï¼‰
report_task = Task(
    description=f"""
    ä»¥ä¸‹ã®ç‚ºæ›¿ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‰ãƒ«å††ï¼‰ã‚’åˆ†æã—ã€æ—¥æœ¬ã®å€‹äººæŠ•è³‡å®¶å‘ã‘ã«ãƒ–ãƒ­ã‚°è¨˜äº‹ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚
    
    ã€ç‚ºæ›¿ãƒ‡ãƒ¼ã‚¿ã€‘
    - ç¾åœ¨ã®ãƒ¬ãƒ¼ãƒˆ: {latest['Close']:.2f}å††
    - å‰æ—¥æ¯”: {latest['Close'] - prev['Close']:.2f}å††
    - å½“æ—¥ã®é«˜å€¤: {latest['High']:.2f}å††
    - å½“æ—¥ã®å®‰å€¤: {latest['Low']:.2f}å††

    ã€SEOãƒ»è¨˜äº‹æ§‹æˆãƒ«ãƒ¼ãƒ«ã€‘
    1. èª­è€…ãŒã‚¯ãƒªãƒƒã‚¯ã—ãŸããªã‚‹å°‚é–€çš„ãªã‚¿ã‚¤ãƒˆãƒ«ã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚
    2. è¦‹å‡ºã—ï¼ˆ##ï¼‰ã«ã¯ã€Œãƒ‰ãƒ«å††ã€ã€Œäºˆæƒ³ã€ã€Œä»Šå¾Œã®è¦‹é€šã—ã€ã¨ã„ã†ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å¿…ãšè‡ªç„¶ã«å«ã‚ã¦ãã ã•ã„ã€‚
    3. ã€Œä»Šæ—¥ã®ãƒã‚¤ãƒ³ãƒˆï¼ˆ3è¡Œè¦ç´„ï¼‰ã€ã‚’å†’é ­ã«å…¥ã‚Œã¦ãã ã•ã„ã€‚
    4. å…·ä½“çš„ãªæ•°å€¤ï¼ˆã‚µãƒãƒ¼ãƒˆãƒ»ãƒ¬ã‚¸ã‚¹ã‚¿ãƒ³ã‚¹ãƒ©ã‚¤ãƒ³ï¼‰ã‚’æŒ™ã’ã¦ãã ã•ã„ã€‚
    5. æ—¥æœ¬èªã§ã€è¦ªã—ã¿ã‚„ã™ãã‚‚å°‚é–€çš„ãªãƒˆãƒ¼ãƒ³ã§åŸ·ç­†ã—ã¦ãã ã•ã„ã€‚
    """,
    expected_output="Markdownå½¢å¼ã®é«˜å“è³ªãªç›¸å ´åˆ†æãƒ¬ãƒãƒ¼ãƒˆ",
    agent=analyst
)

# 5. å®Ÿè¡Œ
crew = Crew(
    agents=[analyst],
    tasks=[report_task],
    process=Process.sequential
)

result = crew.start()

# 6. ä¿å­˜ï¼ˆâ˜…SEOç”¨ãƒ¡ã‚¿è¨˜è¿° + è³‡ç”£ç©ã¿ä¸Šã’ãƒ¢ãƒ¼ãƒ‰ï¼‰

today_str = datetime.now().strftime("%Y-%m-%d")
today_title = datetime.now().strftime("%Y/%m/%d")

# ã€SEOä¿®æ­£ã€‘æ¤œç´¢çµæœã«è¡¨ç¤ºã•ã‚Œã‚‹ç´¹ä»‹æ–‡ï¼ˆdescriptionï¼‰ã‚’è‡ªå‹•ç”Ÿæˆ
frontmatter = f"""---
title: "{today_title} ãƒ‰ãƒ«å††AIå¸‚å ´åˆ†æ"
date: {today_str}
description: "ã€AIåˆ†æã€‘{today_title}ã®ãƒ‰ãƒ«å††ç›¸å ´ã‚’å¾¹åº•è§£èª¬ã€‚æœ€æ–°ãƒ¬ãƒ¼ãƒˆ {latest['Close']:.2f}å††ã‚’è¸ã¾ãˆãŸãƒˆãƒ¬ãƒ¼ãƒ‰æˆ¦ç•¥ã¨ã€ãƒ—ãƒ­ã«ã‚ˆã‚‹ä»Šå¾Œã®è¦‹é€šã—ã‚’å…¬é–‹ä¸­ã€‚"
tags: ["USDJPY", "ãƒ‰ãƒ«å††äºˆæƒ³", "FXåˆ†æ", "ãƒ†ã‚¯ãƒ‹ã‚«ãƒ«åˆ†æ"]
---

"""

# åºƒå‘Šãƒ–ãƒ­ãƒƒã‚¯
ad_block = """
<br>

---

## ğŸ“¢ åˆå¿ƒè€…ã‹ã‚‰ãƒ—ãƒ­ã¾ã§é¸ã¶FXå£åº§

FXã‚’å§‹ã‚ã‚‹ãªã‚‰ã€ä¿¡é ¼æ€§ã¨ãƒ„ãƒ¼ãƒ«ã®ä½¿ã„ã‚„ã™ã•ãŒé‡è¦ã§ã™ã€‚

### ğŸ¥‡ DMM FX
**ã‚¹ãƒãƒ›ã§æœ€çŸ­1æ™‚é–“ã§å–å¼•é–‹å§‹ï¼**
* æ‰‹æ•°æ–™ãŒå®‰ãã€åˆå¿ƒè€…ã§ã‚‚ç›´æ„Ÿçš„ã«æ“ä½œå¯èƒ½ã€‚
* [ğŸ‘‰ DMM FXã®ç„¡æ–™å£åº§é–‹è¨­ã¯ã“ã¡ã‚‰](ã‚ãªãŸã®ãƒªãƒ³ã‚¯)

### ğŸ¥ˆ GMOã‚¯ãƒªãƒƒã‚¯è¨¼åˆ¸
**æ¥­ç•Œæœ€å®‰æ°´æº–ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ï¼**
* é«˜æ©Ÿèƒ½ãƒãƒ£ãƒ¼ãƒˆãŒç„¡æ–™ã§ä½¿ã„æ”¾é¡Œã€‚
* [ğŸ‘‰ GMOã‚¯ãƒªãƒƒã‚¯è¨¼åˆ¸ã®è©³ç´°ã‚’è¦‹ã‚‹](ã‚ãªãŸã®ãƒªãƒ³ã‚¯)

> â€»æœ¬è¨˜äº‹ã¯AIã«ã‚ˆã‚‹å¸‚å ´åˆ†æã§ã‚ã‚Šã€æŠ•è³‡ã®æœ€çµ‚æ±ºå®šã¯ã”è‡ªèº«ã®åˆ¤æ–­ã§è¡Œã£ã¦ãã ã•ã„ã€‚
"""

final_content = frontmatter + str(result) + "\n\n" + ad_block

# ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã¨ä¿å­˜
save_path = f"quartz/content/posts/{today_str}-report.md"
os.makedirs("quartz/content/posts", exist_ok=True)

with open(save_path, "w", encoding="utf-8") as f:
    f.write(final_content)

print(f"\nâœ… è¨˜äº‹ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ ä¿å­˜å…ˆ: {save_path}")